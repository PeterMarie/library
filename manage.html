<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage QuillWizards Library</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f3f8; color: #333; }
        h1 { color: #6f42c1; font-size: 28px; margin-bottom: 25px; }
        .search-container { margin-bottom: 25px; display: flex; flex-wrap: wrap; gap: 10px; }
        .search-container input, .search-container select { padding: 8px 10px; border: 1px solid #bbb; border-radius: 6px; font-size: 14px; }
        .book-form { background-color: #fff; border-left: 5px solid #6f42c1; border-radius: 8px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(111, 66, 193, 0.05); }
        .book-form input, .book-form select, .book-form textarea { width: 100%; margin-top: 6px; margin-bottom: 12px; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; }
        .book-form label { font-weight: bold; display: block; margin-top: 10px; }
        .book-form button { padding: 8px 14px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 8px; }
        .update-btn { background-color: #5cb85c; color: #fff; }
        .delete-btn { background-color: #d9534f; color: #fff; }
        .book-cover { width: 100px; height: 140px; object-fit: cover; border: 1px solid #ccc; margin-bottom: 10px; }
        .pagination { text-align: center; margin-top: 20px; }
        .pagination button { margin: 0 5px; padding: 6px 12px; border: 1px solid #6f42c1; background-color: #fff; color: #6f42c1; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>üõ†Ô∏è Manage QuillWizards Library</h1>

    <div class="search-container">
        <input type="text" id="search" placeholder="Search by title, author, or keyword" onkeyup="fetchBooks()">
    </div>

    <div id="book-list"></div>
    <div class="pagination" id="pagination"></div>

    <script>
        let metaData = { categories: [], formats: {}, languages: {}, reading_status: {} };
        let currentPage = 1;
        const pageSize = 10;

        function fetchMeta() {
            $.getJSON('api/get_filters.php', function(data) {
                metaData = data;
                fetchBooks();
            });
        }

        function buildSelect(name, selectedValue, options) {
            let html = `<select class="${name}">`;
            options.forEach(opt => {
                html += `<option value="${opt.id}"${opt.id == selectedValue ? ' selected' : ''}>${opt.name}</option>`;
            });
            html += '</select>';
            return html;
        }

        function buildSubcategorySelect(selectedValue, categoryId) {
            const category = metaData.categories.find(cat => cat.id == categoryId);
            const subcategories = category ? category.subcategories : [];
            let html = `<select class="subcategory_id">`;
            subcategories.forEach(sub => {
                html += `<option value="${sub.id}"${sub.id == selectedValue ? ' selected' : ''}>${sub.name}</option>`;
            });
            html += `</select>`;
            return html;
        }

        function fetchBooks() {
            const query = $('#search').val();
            $.post('api/list_documents.php', { search: query }, function(response) {
                renderBooks(response.documents);
            }, 'json');
        }

        function renderBooks(books) {
            const container = $('#book-list');
            const pagination = $('#pagination');
            container.empty();
            pagination.empty();

            const totalPages = Math.ceil(books.length / pageSize);
            const start = (currentPage - 1) * pageSize;
            const pageBooks = books.slice(start, start + pageSize);

            pageBooks.forEach(book => {
                const categorySelect = buildSelect('category_id', book.category_id, metaData.categories);
                const subcategorySelect = buildSubcategorySelect(book.subcategory_id, book.category_id);

                const form = `
                    <div class="book-form" data-id="${book.id}">
                        <img src="${book.cover_image}" class="book-cover" alt="Cover">
                        <input type="file" class="cover-upload">

                        <label>Title</label>
                        <input type="text" class="title" value="${book.title}">

                        <label>Authors (comma separated)</label>
                        <input type="text" class="authors" value="${book.authors.join(', ')}">

                        <label>Category</label>
                        ${categorySelect}

                        <label>Subcategory</label>
                        ${subcategorySelect}

                        <label>Format</label>
                        ${buildSelect('format_id', book.format_id, metaData.formats)}

                        <label>Language</label>
                        ${buildSelect('language_id', book.language_id, metaData.languages)}

                        <label>Publisher</label>
                        <input type="text" class="publisher" value="${book.publisher}">

                        <label>Year</label>
                        <input type="number" class="publication_year" value="${book.publication_year}">
                        
                        <label>Page Count</label>
                        <input type="number" class="page_count" value="${book.page_count}">

                        <label>Summary</label>
                        <textarea class="summary">${book.summary || ''}</textarea>

                        <button class="update-btn" onclick="updateBook('${book.id}')">Update</button>
                        <button class="delete-btn" onclick="deleteBook('${book.id}')">Delete</button>
                    </div>`;

                container.append(form);
            });

            for (let i = 1; i <= totalPages; i++) {
                pagination.append(`<button onclick="goToPage(${i})">${i}</button>`);
            }

            $('.category_id').on('change', function () {
                const form = $(this).closest('.book-form');
                const categoryId = $(this).val();
                const subSelect = buildSubcategorySelect(null, categoryId);
                form.find('.subcategory_id').replaceWith(subSelect);
            });
        }

        function goToPage(page) {
            currentPage = page;
            fetchBooks();
        }

        function updateBook(id) {
            if (!confirm('Are you sure you want to update this book?')) return;

            const form = $(`div[data-id='${id}']`);
            const fileInput = form.find('.cover-upload')[0];
            const formData = new FormData();

            formData.append('id', id);
            formData.append('title', form.find('.title').val());
            formData.append('authors', form.find('.authors').val());
            formData.append('category_id', form.find('.category_id').val());
            formData.append('subcategory_id', form.find('.subcategory_id').val());
            formData.append('format_id', form.find('.format_id').val());
            formData.append('language_id', form.find('.language_id').val());
            formData.append('publisher', form.find('.publisher').val());
            formData.append('publication_year', form.find('.publication_year').val());
            formData.append('page_count', form.find('.page_count').val());
            formData.append('summary', form.find('.summary').val());
            if (fileInput.files.length > 0) {
                formData.append('cover_image', fileInput.files[0]);
            }

            $.ajax({
                url: 'api/update_document.php',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function(response) {
                    alert(response.message);
                    if(response.success){
                      fetchBooks();
                    }
                }
            });
        }

        function deleteBook(id) {
            if (confirm('Are you sure you want to delete this book?')) {
                $.post('api/delete_document.php', { id }, function(response) {
                    if(response.success){
                      alert('Book deleted'); 
                    fetchBooks();
                    } else {
                      alert(response.message);
                    }
                }), 'json';
            }
        }

        $(document).ready(function() {
            fetchMeta();
        });
    </script>
</body>
</html>
