<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage QuillWizards Library</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css" >
    <style>
        .book-cover { 
            width: 100px; height: 140px; object-fit: cover; border: 1px solid #ccc; margin-bottom: 10px; 
        }
        .search-container {
            margin-bottom: 0;
            gap: 10px;
            align-self: flex-start;
        }
    
        .search-container input,
        .search-container select {
            padding: 8px 10px;
            border: 1px solid #bbb;
            border-radius: 6px;
            font-size: 14px;
            transition: box-shadow 0.3s ease;
        }
    
        .search-container input:focus,
        .search-container select:focus {
            outline: none;
            border-color: #6f42c1;
            box-shadow: 0 0 0 2px rgba(111, 66, 193, 0.2);
        }

    </style>
</head>
<body>
    <header>
        <div class="top-header">
            <div class="title-div">
                <img src="../images/qw_silver.png" alt="QuillWizards Logo">
                <h1>QuillWizards Library <span class="header-admin-tag">Admin Pages</span></h1>
            </div>
            <nav class="nav-links">
                <a href="upload.html" id="upload-link">üì§ Add New Book</a>
                <a href="index.php" id="library-link">üìö Public Library</a>
                <a href="../" id="home-link">üè† QuillWizards Home</a>
            </nav>
        </div>
        <div class="search-container">
            <input type="text" id="search" placeholder="Search by title, author, or keyword" onkeyup="fetchBooks()">
        </div>
    </header>
    <main>
        <h2>Manage Books</h2>
    
        <div id="book-list" class="document-list"></div>
        <div class="pagination" id="pagination"></div>
    </main>
    <footer>
        &copy; 2025 QuillWizards. All rights reserved.
    </footer>


    <script>
        let metaData = { categories: [], formats: {}, languages: {}, reading_status: {} };
        let currentPage = 1;
        const pageSize = 10;

        function fetchMeta() {
            $.getJSON('api/get_filters.php', function(data) {
                metaData = data;
                fetchBooks();
            });
        }

        function buildSelect(name, selectedValue, options) {
            let html = `<select class="${name}">`;
            options.forEach(opt => {
                html += `<option value="${opt.id}"${opt.id == selectedValue ? ' selected' : ''}>${opt.name}</option>`;
            });
            html += '</select>';
            return html;
        }

        function buildSubcategorySelect(selectedValue, categoryId) {
            const category = metaData.categories.find(cat => cat.id == categoryId);
            const subcategories = category ? category.subcategories : [];
            let html = `<select class="subcategory_id">`;
            subcategories.forEach(sub => {
                html += `<option value="${sub.id}"${sub.id == selectedValue ? ' selected' : ''}>${sub.name}</option>`;
            });
            html += `</select>`;
            return html;
        }

        function fetchBooks() {
            const query = $('#search').val();
            $.post('api/list_documents.php', { search: query }, function(response) {
                renderBooks(response.documents);
            }, 'json');
        }

        function renderBooks(books) {
            const container = $('#book-list');
            const pagination = $('#pagination');
            container.empty();
            pagination.empty();

            const totalPages = Math.ceil(books.length / pageSize);
            const start = (currentPage - 1) * pageSize;
            const pageBooks = books.slice(start, start + pageSize);

            pageBooks.forEach(book => {
                const categorySelect = buildSelect('category_id', book.category_id, metaData.categories);
                const subcategorySelect = buildSubcategorySelect(book.subcategory_id, book.category_id);

                const form = `
                    <div class="book-form" data-id="${book.id}">
                        <img src="${book.cover_image}" class="book-cover" alt="Cover">
                        <input type="hidden" class="cover_image" value="${book.cover_image}">
                        <input type="file" class="cover-upload">

                        <label>Title</label>
                        <input type="text" class="title" value="${book.title}">

                        <label>Authors (comma separated)</label>
                        <input type="text" class="authors" value="${book.authors.join(', ')}">

                        <label>Category</label>
                        ${categorySelect}

                        <label>Subcategory</label>
                        ${subcategorySelect}

                        <label>Format</label>
                        ${buildSelect('format_id', book.format_id, metaData.formats)}

                        <label>Language</label>
                        ${buildSelect('language_id', book.language_id, metaData.languages)}

                        <label>Publisher</label>
                        <input type="text" class="publisher" value="${book.publisher}">

                        <label>Year</label>
                        <input type="number" class="publication_year" value="${book.publication_year}">
                        
                        <label>Page Count</label>
                        <input type="number" class="page_count" value="${book.page_count}">

                        <label>Summary</label>
                        <textarea class="summary">${book.summary || ''}</textarea>

                        <a href="${book.file_path}" target="_blank" class="download-link"><i class="fa fa-download"></i> Download</a>
                        <button class="update-btn" onclick="updateBook('${book.id}')">Update</button>
                        <button class="delete-btn" onclick="deleteBook('${book.id}')">Delete</button>
                    </div>`;

                container.append(form);
            });

            for (let i = 1; i <= totalPages; i++) {
                const button = $(`<button>${i}</button>`);
                $(button).on("click", function(){
                    goToPage(i);
                });
                if (i === currentPage) button.addClass('active');
                pagination.append(button);
            }

            $('.category_id').on('change', function () {
                const form = $(this).closest('.book-form');
                const categoryId = $(this).val();
                const subSelect = buildSubcategorySelect(null, categoryId);
                form.find('.subcategory_id').replaceWith(subSelect);
            });

            $('.cover-upload').on('change', function () {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        $(this).closest('.book-form').find('.book-cover').attr('src', e.target.result);
                    }.bind(this);
                    reader.readAsDataURL(file);
                }
            });
        }

        function goToPage(page) {
            currentPage = page;
            fetchBooks();
        }

        function updateBook(id) {
            if (!confirm('Are you sure you want to update this book?')) return;

            const form = $(`div[data-id='${id}']`);
            const fileInput = form.find('.cover-upload')[0];
            const formData = new FormData();

            formData.append('id', id);
            formData.append('title', form.find('.title').val());
            formData.append('authors', form.find('.authors').val());
            formData.append('category_id', form.find('.category_id').val());
            formData.append('subcategory_id', form.find('.subcategory_id').val());
            formData.append('format_id', form.find('.format_id').val());
            formData.append('language_id', form.find('.language_id').val());
            formData.append('publisher', form.find('.publisher').val());
            formData.append('publication_year', form.find('.publication_year').val());
            formData.append('page_count', form.find('.page_count').val());
            formData.append('summary', form.find('.summary').val());
            if (fileInput.files.length > 0) {
                formData.append('cover_image', fileInput.files[0]);
            } else {
                formData.append('cover_image', form.find('.cover_image').val());
            }

            $.ajax({
                url: 'api/update_document.php',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function(response) {
                    alert(response.message);
                    if(response.success){
                      fetchBooks();
                    }
                }
            });
        }

        function deleteBook(id) {
            if (confirm('Are you sure you want to delete this book?')) {
                $.post('api/delete_document.php', { id }, function(response) {
                    if(response.success){
                      alert('Book deleted'); 
                    fetchBooks();
                    } else {
                      alert(response.message);
                    }
                }), 'json';
            }
        }

        $(document).ready(function() {
            fetchMeta();
        });
    </script>
</body>
</html>
